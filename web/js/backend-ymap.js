var map,
    marker,
    poligons = [],
    geocoder;


var districts = {
  16: [37.618886,55.774163,37.618371,55.779775,37.615625,55.781516,37.61511,55.783257,37.617341,55.786449,37.616311,55.792543,37.624379,55.792349,37.628156,55.792156,37.630731,55.791479,37.639486,55.791866,37.64515,55.792833,37.647725,55.790802,37.653047,55.789158,37.659227,55.78761,37.66781,55.785869,37.673989,55.784708,37.670556,55.78229,37.665063,55.779194,37.658883,55.776776,37.65236,55.775131,37.649099,55.774357,37.645837,55.772615,37.643605,55.770776,37.638627,55.772421,37.630731,55.773292,37.624723,55.77397],
  15: [37.618543,55.773873,37.617856,55.776195,37.616998,55.779291,37.613221,55.782096,37.607728,55.784031,37.604467,55.784999,37.601205,55.785095,37.599145,55.792059,37.59142,55.791286,37.589189,55.790802,37.587815,55.785676,37.585069,55.777163,37.595884,55.770389,37.605668,55.773196],
  13: [37.595369,55.769519,37.583696,55.776679,37.575971,55.775518,37.56447,55.77455,37.553655,55.773583,37.54696,55.773196,37.543355,55.769809,37.53872,55.767293,37.536145,55.762163,37.533914,55.756356,37.532197,55.751709,37.533055,55.75016,37.546102,55.753548,37.54754,55.755189,37.549461,55.756203,37.553785,55.756637,37.558722,55.756434,37.561043,55.754286,37.564998,55.754829,37.570161,55.754368,37.574308,55.752865,37.582258,55.752955,37.583739,55.759332,37.5867,55.763373],
  12: [37.575456,55.751999,37.576657,55.747449,37.575456,55.744641,37.572538,55.741058,37.568761,55.737281,37.564985,55.734278,37.559148,55.731276,37.554341,55.728757,37.549878,55.727207,37.546445,55.726335,37.543698,55.724204,37.54284,55.720716,37.54387,55.717325,37.546788,55.714805,37.551423,55.712286,37.556916,55.711316,37.561036,55.711316,37.566701,55.712092,37.573224,55.713739,37.577859,55.71558,37.582151,55.718584,37.586271,55.72246,37.590905,55.72711,37.593137,55.73021,37.595025,55.732632,37.596914,55.734085,37.58567,55.738201,37.583653,55.741712,37.582301,55.746856,37.582483,55.752235],
  18: [37.578202,55.713332,37.581979,55.711103,37.583524,55.710328,37.596227,55.719922,37.593995,55.721666,37.59657,55.722828,37.600175,55.721375,37.608758,55.719922,37.60996,55.721375,37.614766,55.721181,37.615625,55.720212,37.621976,55.721181,37.621804,55.725153,37.623349,55.729319,37.616655,55.728738,37.608415,55.730288,37.600518,55.733387,37.597257,55.730142,37.596313,55.727357,37.591721,55.722768],
  19: [37.623006,55.721084,37.627813,55.721181,37.633134,55.722731,37.635366,55.722247,37.636052,55.7237,37.641374,55.722247,37.643262,55.722247,37.644635,55.72835,37.645494,55.729416,37.652188,55.72806,37.648412,55.730772,37.645837,55.73484,37.640344,55.731934,37.636396,55.730578,37.629873,55.729803,37.623693,55.729416],
  6: [37.682573,55.74801,37.672445,55.750044,37.66884,55.751012,37.66575,55.752948,37.66369,55.752948,37.660257,55.754303,37.655793,55.7544,37.652017,55.753335,37.647554,55.752658,37.645837,55.750818,37.64309,55.750528,37.64206,55.749172,37.642747,55.748204,37.641717,55.746848,37.644979,55.743169,37.647725,55.737358,37.650472,55.732419,37.655107,55.729707,37.658197,55.725735,37.663518,55.726122,37.661372,55.730288,37.665406,55.73116,37.667466,55.73116,37.67193,55.725057,37.678968,55.726607,37.680513,55.727769,37.682058,55.727478,37.680598,55.728932,37.683603,55.729319,37.683774,55.730288,37.685662,55.730385,37.684976,55.732806,37.691842,55.729319,37.693731,55.729707,37.698194,55.735615,37.696992,55.737455,37.694246,55.73886,37.690469,55.743435,37.687722,55.74611],
  17: [37.644807,55.770389,37.648755,55.773196,37.655622,55.775034,37.664205,55.778227,37.669183,55.780742,37.675534,55.784128,37.687551,55.782483,37.701112,55.782193,37.70918,55.780162,37.713815,55.775711,37.696992,55.767099,37.691156,55.769422,37.687207,55.767293,37.684976,55.764196,37.684289,55.761292,37.680513,55.75955,37.674161,55.75955,37.671071,55.759453,37.669011,55.757711,37.670556,55.755484,37.67296,55.753839,37.669526,55.751322,37.66575,55.753161,37.664376,55.752967,37.66163,55.754516,37.657853,55.754904,37.658368,55.761486,37.657252,55.763905,37.652575,55.767341],
  14: [37.530309,55.749172,37.530309,55.745396,37.536145,55.745687,37.541124,55.747139,37.545758,55.748979,37.549878,55.750915,37.554341,55.752754,37.560006,55.7544,37.558461,55.756433,37.55005,55.755852,37.547346,55.755005,37.546703,55.753771],
  11: [37.585584,55.738424,37.583867,55.742685,37.581979,55.746171,37.582151,55.750237,37.583181,55.75227,37.575456,55.752174,37.576829,55.747139,37.575113,55.74404,37.570649,55.738521,37.565156,55.73455,37.556745,55.730094,37.559148,55.728641,37.573568,55.73547,37.574083,55.73484,37.572709,55.732612],
  4: [37.609445,55.772596,37.615281,55.766112,37.619573,55.75924,37.625753,55.760111,37.629014,55.760111,37.630559,55.760595,37.637254,55.764951,37.635881,55.766112,37.642575,55.769983,37.637769,55.771531,37.627984,55.773176,37.618715,55.773176],
  3: [37.594167,55.767486,37.596914,55.769615,37.602063,55.771357,37.608415,55.772712,37.615625,55.765164,37.619401,55.759163,37.615281,55.757614,37.611505,55.754807,37.606698,55.756356,37.606012,55.75442,37.601892,55.754032,37.599145,55.757227,37.604037,55.762744,37.601162,55.765018,37.598802,55.764196],
  2: [37.59348,55.767177,37.598802,55.76408,37.601033,55.764757,37.602922,55.763402,37.597429,55.757595,37.589704,55.757788,37.585412,55.758756,37.588502,55.763305],
  1: [37.586614,55.738908,37.583524,55.746848,37.583867,55.752658,37.585241,55.758659,37.590734,55.757595,37.597429,55.757304,37.599145,55.757304,37.601377,55.753335,37.603093,55.75411,37.60584,55.754303,37.607042,55.755949,37.615453,55.753045,37.612363,55.748785,37.608844,55.746025,37.606698,55.742878,37.601119,55.744863],
  9: [37.60687,55.742104,37.601377,55.744912,37.586614,55.738424,37.597257,55.734937,37.603265,55.737843,37.606012,55.739295],
  8: [37.601205,55.733872,37.60893,55.731256,37.61511,55.730094,37.622663,55.729997,37.619229,55.732516,37.619058,55.735324,37.617685,55.738521,37.614938,55.743459,37.619744,55.745202,37.625581,55.746558,37.625066,55.74801,37.615281,55.747236,37.610818,55.745396,37.609101,55.74283,37.608586,55.740675,37.608157,55.737855],
  7: [37.624723,55.730094,37.636052,55.731256,37.644807,55.736293,37.642404,55.74191,37.638284,55.74588,37.632447,55.747914,37.625581,55.748494,37.626525,55.745783,37.620946,55.744331,37.615281,55.742394,37.618629,55.738085,37.619444,55.733896,37.620367,55.73122],
  10: [37.639657,55.748204,37.641545,55.749656,37.64309,55.750818,37.645494,55.751399,37.647039,55.754013,37.642575,55.754884,37.639486,55.755368,37.638799,55.757111,37.634507,55.760692,37.632447,55.760692,37.626783,55.759627,37.618543,55.758079,37.612706,55.754207,37.615625,55.753142,37.611848,55.748688,37.612363,55.747817,37.622749,55.74985,37.627426,55.750189,37.633542,55.749971],
  5: [37.631589,55.760692,37.634336,55.760499,37.639486,55.757014,37.639486,55.755659,37.642747,55.755465,37.647382,55.754303,37.647554,55.753142,37.653218,55.753819,37.65648,55.754691,37.656823,55.758369,37.65648,55.762047,37.653562,55.765241,37.650815,55.76737,37.64515,55.769402,37.643605,55.769983,37.637082,55.766209,37.638456,55.765096,37.635709,55.7627]
}

var districts_comsell = {
  6: [37.634164,55.748998,37.637254,55.75471,37.643605,55.752774,37.652016,55.752968,37.659055,55.754226,37.664719,55.753258,37.664891,55.752096,37.667294,55.75229,37.679826,55.74832,37.688752,55.745416,37.690812,55.743479,37.694245,55.739412,37.697335,55.737572,37.699223,55.735828,37.697678,55.73302,37.695447,55.729823,37.693215,55.728951,37.68549,55.732777,37.68652,55.730017,37.684975,55.729726,37.684975,55.728757,37.682401,55.728757,37.683087,55.726626,37.679482,55.726239,37.659055,55.723429,37.657252,55.72682,37.651029,55.732681,37.647242,55.73492,37.644828,55.739097,37.639668,55.744581],
  7: [37.655278,55.727769,37.653561,55.72651,37.647038,55.72806,37.645493,55.72651,37.644807,55.721181,37.63691,55.72215,37.63691,55.720794,37.633305,55.720988,37.622834,55.718468,37.620431,55.725444,37.624207,55.725735,37.624207,55.748882,37.63382,55.749366,37.640172,55.744622,37.647382,55.735809],
  8: [37.622319,55.718856,37.620602,55.725541,37.624379,55.725444,37.624036,55.749366,37.612878,55.747623,37.60584,55.742588,37.603436,55.737843,37.598286,55.731354,37.593823,55.724572,37.585584,55.717209,37.57906,55.713333,37.584039,55.710037,37.598372,55.719098,37.608629,55.717717,37.609981,55.71974,37.612888,55.719298,37.616574,55.718108],
  12: [37.612363,55.747527,37.605496,55.743072,37.604295,55.738424,37.597771,55.735034,37.591763,55.728254,37.584554,55.720697,37.579404,55.71653,37.572537,55.713042,37.562238,55.710813,37.552968,55.711782,37.548161,55.714108,37.544556,55.717596,37.544041,55.721666,37.547646,55.726122,37.560435,55.731499,37.569233,55.737092,37.573117,55.741729,37.574887,55.745887,37.582123,55.745738,37.585913,55.74731,37.58901,55.746256,37.597596,55.74786,37.60189,55.747306,37.602148,55.749062,37.605882,55.750618,37.612212,55.749072],
  1: [37.606183,55.750644,37.60172,55.749192,37.601548,55.747352,37.597771,55.74803,37.58833,55.746384,37.585412,55.747352,37.582322,55.745706,37.574597,55.745803,37.576142,55.748901,37.574254,55.751031,37.578374,55.754904,37.586099,55.755388,37.586099,55.758389,37.600861,55.754517,37.611504,55.75442,37.611161,55.752871,37.60644,55.752919],
  13: [37.611848,55.754129,37.601033,55.754517,37.585927,55.758582,37.585927,55.755388,37.578374,55.755291,37.573911,55.751225,37.571679,55.753452,37.567387,55.754033,37.563096,55.754323,37.561379,55.754129,37.559148,55.756162,37.549706,55.755001,37.547646,55.753742,37.533398,55.749966,37.533742,55.754226,37.53666,55.761486,37.539235,55.767099,37.542153,55.768841,37.545758,55.772131,37.549706,55.773293,37.556916,55.773486,37.562753,55.77397,37.572194,55.774938,37.579404,55.775518,37.583352,55.776873,37.598973,55.767777,37.598029,55.766374,37.600475,55.76422,37.602557,55.765273,37.614412,55.756507],
  3: [37.613908,55.756453,37.602921,55.765261,37.600175,55.764293,37.5976,55.766035,37.599145,55.767777,37.583524,55.776969,37.589703,55.790512,37.599831,55.791866,37.602321,55.784564,37.60481,55.784999,37.614594,55.78171,37.619744,55.778421,37.619572,55.772906,37.623177,55.773002,37.623349,55.766809,37.621375,55.765696,37.622319,55.75955,37.617427,55.758486],
  16: [37.622319,55.759163,37.621804,55.765648,37.623006,55.766712,37.623177,55.773002,37.619058,55.773099,37.619916,55.778711,37.614251,55.781807,37.618199,55.786256,37.617513,55.791963,37.629529,55.791673,37.632104,55.790996,37.634636,55.791334,37.635794,55.795541,37.642232,55.791769,37.645837,55.779195,37.642661,55.778856,37.638284,55.771938,37.633391,55.771454,37.63382,55.765938,37.627383,55.762648,37.630902,55.762454,37.63176,55.760421,37.629014,55.759453,37.625838,55.760276],
  31: [37.631417,55.760325,37.631074,55.762454,37.628327,55.762454,37.633649,55.765745,37.633477,55.771841,37.637597,55.772228,37.642747,55.778904,37.645665,55.779001,37.644292,55.783645,37.64206,55.791673,37.644807,55.792446,37.652703,55.789158,37.662831,55.786546,37.675877,55.784031,37.679139,55.783645,37.683087,55.782967,37.679911,55.778421,37.678152,55.779243,37.665599,55.773752,37.664988,55.770329,37.647516,55.769295,37.640496,55.765584,37.635098,55.760438],
  17: [37.679997,55.778034,37.683946,55.78258,37.690125,55.782097,37.696648,55.78171,37.705918,55.781033,37.711583,55.778421,37.714845,55.775421,37.69785,55.766616,37.692014,55.769035,37.687035,55.766132,37.685319,55.761583,37.683259,55.759647,37.679311,55.759163,37.672616,55.758776,37.671929,55.75655,37.674161,55.753258,37.671929,55.750644,37.667294,55.752193,37.664891,55.752096,37.664548,55.753258,37.658883,55.754226,37.651502,55.753161,37.64412,55.752677,37.636739,55.75442,37.631245,55.759744,37.635194,55.760567,37.638541,55.764559,37.647425,55.769071,37.664741,55.770263,37.665331,55.773665,37.677814,55.778945],
  10: [37.631245,55.75955,37.636567,55.754517,37.634164,55.749289,37.624551,55.749289,37.612534,55.74774,37.611848,55.748998,37.606011,55.750741,37.606698,55.752677,37.611419,55.752629,37.612191,55.75442,37.614423,55.756453,37.617513,55.758486,37.625752,55.760179]
}

var districts2 = {
  1: 'Арбат',
  2: 'Патриаршие пруды',
  3: 'Тверской',
  4: 'Сретенка',
  5: 'Чистые пруды',
  6: 'Таганский',
  7: 'Замоскворечье',
  8: 'Якиманка',
  9: 'Остоженка',
  10: 'Китай город',
  11: 'Плющиха',
  12: 'Хамовники',
  13: 'Пресненский',
  14: 'Москва Сити',
  15: 'Новослободский',
  16: 'Мещанский',
  17: 'Басманный',
  18: 'Донской',
  19: 'Даниловский',
  20: 'Северо-Западный АО',
  21: 'Северный АО',
  22: 'Северо-Восточный АО',
  23: 'Восточный АО',
  24: 'Юго-Восточный АО',
  25: 'Южный АО',
  26: 'Юго-Западный АО',
  28: 'Западный АО',
  30: 'Воробьевы горы',
  31: 'Красносельский',
  32: 'Зеленоградский АО',
}


$(function() {
  $('#sf_admin_form_tab_menu').find('a:contains("Метка")').bind('click', function() {
    $('input#lot_address_string').after(' <button class="doGeocode"/>');
    $('.doGeocode').text('Найти').addClass('sf_button ui-corner-all ui-state-default');

    $(this).unbind('click');
    ymaps.ready(initMap);

    if ($('#lot_lat').val() != '' && $('#lot_lng').val() != '') {
      doMarker([$('#lot_lat').val(), $('#lot_lng').val()]);
    }
    else {
      //doMarker([55.7557, 37.6176]);
    }

    $('.doGeocode').click(function() {
      doGeocode($('#lot_address_string').val());
      return false;
    });
    $('#lot_address_string').keypress(function(event) {
      if (event.which == 13) {
        $('.doGeocode').click();
        return false;
      }
    });

    //#20799
    var txt_geocode_timeout_id = null;
    $('table.geocode input').keyup(function(event){
      var obj = $(this);
      clearTimeout(txt_geocode_timeout_id);
      txt_geocode_timeout_id = setTimeout(function(){
        obj.attr('disabled', true);
        var addr = $('table.geocode input:lt(5)').map(function() { return this.value; }).get().join(', ');
        if ($('#lot_address_building').val()) addr += 'к'+$('#lot_address_building').val();
        if ($('#lot_address_construction').val()) addr += 'с'+$('#lot_address_construction').val();
        doGeocode(addr);
        obj.attr('disabled', false);
      }, 1000);
    });
  });

});


function initMap()
{
  map = new ymaps.Map('ymap', {
    center: [55.757, 37.618],
    zoom:   15,
    type:   'yandex#map'
  });

  map.controls
    .add('zoomControl')
    .add('typeSelector');

  doCreatePoligons();
};

function doGeocode(text)
{
  if (text == '') {
    doMarker();
    return;
  }

  geocoder = new ymaps.geocode(text, {results: 1});
  geocoder.then(function(res){
    if (res.geoObjects.getLength()) {
      doMarker(res.geoObjects.get(0).geometry.getCoordinates());
      doReverseGeocode(res.geoObjects.get(0).geometry.getCoordinates());
    }
    else {
      doMarker();
    }
  });

  if ($('#lot_lat').val() != '' && $('#lot_lng').val() != '') {
    doCheckCordsUnderPoligon([parseFloat($('#lot_lat').val()), parseFloat($('#lot_lng').val())]);
  }
};

function doMarker(coords)
{
  if (typeof coords == 'undefined' || !coords.length) {
    if (marker) {
      map.geoObjects.remove(marker);
      marker = null;
    }

    doLatLng();
    return;
  }

  if (!marker) {
    marker = new ymaps.Placemark(coords, {}, {draggable: true, hasBalloon: false});
    map.geoObjects.add(marker);

    marker.events.add('dragend', function(obj){
      doLatLng(obj.originalEvent.target.geometry.getCoordinates());
      doReverseGeocode(obj.originalEvent.target.geometry.getCoordinates());
    });
  }
  else {
    marker.geometry.setCoordinates(coords);
  }

  map.setCenter(marker.geometry.getCoordinates());
  map.setZoom(15);

  doLatLng(marker.geometry.getCoordinates());
};

function doLatLng(coords)
{
  var lat = typeof coords != 'undefined' && coords[0] ? parseFloat(coords[0]).toFixed(6) : '';
  var lng = typeof coords != 'undefined' && coords[1] ? parseFloat(coords[1]).toFixed(6) : '';

  $('#lot_lat').val(lat);
  $('#lot_lng').val(lng);
};

function doReverseGeocode(coords)
{
  if (typeof coords != 'undefined'){
    $.getJSON('/backend.php/lot/geocode?coords=' + coords[1] + ',' + coords[0], function(data){
      for(i in data){
        $('#lot_address_' + i).val(data[i]);
        $('.geocode_' + i).text(data[i]);
      }
    });

    doCheckCordsUnderPoligon(coords);
  }
};

function doCreatePoligons()
{
  var dist = [];
  if ($('#lot_type_real').val() != 'comsell' && $('#lot_type_real').val() != 'comrent'){
    dist = districts;
  }
  else {
    dist = districts_comsell;
  }

  $.each(dist, function(index, value) {
    poligons[index] = new ymaps.geometry.pixel.Polygon([getPoligon(value)]);
  });
};

function doCheckCordsUnderPoligon(coords)
{
  for (var index in poligons) {
    if (poligons[index].contains(coords)) {
      $('#lot_district_id').val(index);
      return false;
    }
  }
  $.getJSON('/backend.php/lot/geocode?coords=' + coords[1] + ',' + coords[0] + '&kind=true', function (data) {
    if (typeof data['kind'] != 'undefined') {
      $.each(districts2, function (index, value) {
        if (data['kind'].search(value.split(/[\s,]+/, 2)[0]) === 0) {
          $('#lot_district_id').val(index);
          return false;
        }
      });
    }
  });

  $('#lot_district_id').val('');

  return false;
};

function getPoligon(ditrict)
{
  var i = 0, j = 1, result = [];
  for (var k = 0; k < ditrict.length; k++) {
    result[k] = [parseFloat(ditrict[j]),parseFloat(ditrict[i])];
    i += 2;
    j += 2;
  }
  return result;
};